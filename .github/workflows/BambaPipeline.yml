# name: Bamba Pipeline

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     strategy:
#       matrix:
#         include:
          # - instance: instance_3
          #   ip: 62.84.183.71
          #   port: 8083
          #   service: nbc_3
          #   deploy_path: /opt/NbcUSSD/instance_3
          # - instance: instance_2
          #   ip: 62.84.183.71
          #   port: 8082
          #   service: nbc_2
          #   deploy_path: /opt/NbcUSSD/instance_2
    #       - instance: instance_1
    #         ip: 62.84.183.71
    #         port: 8081
    #         service: nbc_1
    #         deploy_path: /opt/NbcUSSD/instance_1

    # steps:
    #   - name: Checkout code
    #     uses: actions/checkout@v3

    #   - name: Deploy & Restart Spring Boot Application on ${{ matrix.instance }}
    #     run: |
    #       echo "ðŸš€ Starting deployment on ${{ matrix.instance }}..."
    #       sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ matrix.ip }} << 'EOF'
    #         set -e  # Stop execution on error
    #         echo "ðŸ”„ Stopping service: ${{ matrix.service }}"
    #         sudo systemctl stop ${{ matrix.service }}
    #         echo "ðŸ“ Navigating to repository directory: /opt/BambaRepo"
    #         cd /opt/BambaRepo
    #         echo "ðŸ›  Checking for stale Git processes..."
    #         if [ -f /opt/BambaRepo/.git/index.lock ]; then
    #           echo "âš ï¸ Lock file detected! Removing..."
    #           rm -f /opt/BambaRepo/.git/index.lock
    #         fi
            
    #         if [ -f /opt/BambaRepo/.git/HEAD.lock ]; then
    #           echo "âš ï¸ HEAD lock file detected! Removing..."
    #           rm -f /opt/BambaRepo/.git/HEAD.lock
    #         fi
            
    #         echo "ðŸ›  Ensuring no running Git processes..."
    #         pkill -f git || true
    #         echo "ðŸ›  Pulling latest code..."
    #         git fetch origin main
    #         git reset --hard origin/main
    #         echo "ðŸ”§ Updating application.properties..."
    #         sed -i "s/^server\.port=.*/server.port=${{ matrix.port }}/" src/main/resources/application.properties
    #         echo "âš™ï¸ Building application..."
    #         mvn clean package -DskipTests
    #         echo "ðŸ—‘ Removing old JAR file from instance path: ${{ matrix.deploy_path }}"
    #         rm -f ${{ matrix.deploy_path }}/mobiAd-0.0.1-SNAPSHOT.jar
    #         echo "ðŸ“‚ Copying new JAR file to instance path: ${{ matrix.deploy_path }}"
    #         cp /opt/BambaRepo/target/mobiAd-0.0.1-SNAPSHOT.jar ${{ matrix.deploy_path }}/
    #         echo "ðŸš€ Restarting service: ${{ matrix.service }} on port ${{ matrix.port }}"
    #         sudo systemctl restart ${{ matrix.service }}
    #         echo "âœ… Deployment successful!"
    #       EOF


name: Bamba Pipeline

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Pull code and build once
        run: |
          echo "ðŸš€ Starting single code pull and build..."
          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@62.84.183.71 << 'EOF'
            set -e  # Stop execution on error
            echo "ðŸ“ Navigating to repository directory: /opt/BambaRepo"
            cd /opt/BambaRepo
            echo "ðŸ›  Checking for stale Git processes..."
            if [ -f /opt/BambaRepo/.git/index.lock ]; then
              echo "âš ï¸ Lock file detected! Removing..."
              rm -f /opt/BambaRepo/.git/index.lock
            fi
            
            if [ -f /opt/BambaRepo/.git/HEAD.lock ]; then
              echo "âš ï¸ HEAD lock file detected! Removing..."
              rm -f /opt/BambaRepo/.git/HEAD.lock
            fi
            
            echo "ðŸ›  Ensuring no running Git processes..."
            pkill -f git || true
            echo "ðŸ›  Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            echo "âš™ï¸ Building application (without specific port yet)"
            mvn clean package -DskipTests
            echo "âœ… Code pulled and built successfully!"
          EOF

  deploy:
    runs-on: ubuntu-latest
    needs: build  # Ensure this job runs after the build job
    strategy:
      matrix:
        include:
          - instance: instance_3
            ip: 62.84.183.71
            port: 8083
            service: nbc_3
            deploy_path: /opt/NbcUSSD/instance_3
          - instance: instance_2
            ip: 62.84.183.71
            port: 8082
            service: nbc_2
            deploy_path: /opt/NbcUSSD/instance_2
          - instance: instance_1
            ip: 62.84.183.71
            port: 8081
            service: nbc_1
            deploy_path: /opt/NbcUSSD/instance_1
    steps:
      - name: Deploy to ${{ matrix.instance }}
        run: |
          echo "ðŸš€ Deploying to ${{ matrix.instance }}..."
          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ matrix.ip }} << 'EOF'
            set -e  # Stop execution on error
            echo "ðŸ”„ Stopping service: ${{ matrix.service }}"
            sudo systemctl stop ${{ matrix.service }}
            echo "ðŸ“ Navigating to repository directory: /opt/BambaRepo"
            cd /opt/BambaRepo
            echo "ðŸ—‘ Removing old JAR file from instance path: ${{ matrix.deploy_path }}"
            rm -f ${{ matrix.deploy_path }}/mobiAd-0.0.1-SNAPSHOT.jar
            echo "ðŸ“‚ Copying pre-built JAR file to instance path: ${{ matrix.deploy_path }}"
            cp /opt/BambaRepo/target/mobiAd-0.0.1-SNAPSHOT.jar ${{ matrix.deploy_path }}/
            echo "ðŸ”§ Configuring service to use port ${{ matrix.port }}"
            sudo sed -i "s/ExecStart=.*/ExecStart=\/usr\/bin\/java -jar -Dserver.port=${{ matrix.port }} \/opt\/NbcUSSD\/${{ matrix.instance }}\/mobiAd-0.0.1-SNAPSHOT.jar/" /etc/systemd/system/${{ matrix.service }}.service
            echo "ðŸ”„ Reloading systemd daemon"
            sudo systemctl daemon-reload
            echo "ðŸš€ Restarting service: ${{ matrix.service }} on port ${{ matrix.port }}"
            sudo systemctl restart ${{ matrix.service }}
            echo "âœ… Deployment to ${{ matrix.instance }} successful!"
          EOF
